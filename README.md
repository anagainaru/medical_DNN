# Running ML applications

### Workflow

<img width="799" alt="ML workflow" src="https://user-images.githubusercontent.com/16229479/121259218-d2eac300-c87d-11eb-99b5-458efd61edcd.png">

**Step 1. Divide image into tiles**

Tile extraction from a whole slide image is done in `quip_home/u24_lymphocyte/patch_extraction/save_svs_to_tiles.py` 

```python
pw = int(patch_size_20X * mag / 20);
width = oslide.dimensions[0];
height = oslide.dimensions[1];
for x in range(1, width, pw):
    for y in range(1, height, pw):
       patch = oslide.read_region((x, y), 0, (pw_x, pw_y));
       # filter, resize and write to png file
```

Non-overlapping tiles of fixed size are written one per png file. 

**Step 2 and 3. Divide tile into patches and create batches**

Patch extraction is implemented in `u24_lymphocyte/prediction/lymphocyte/pred.py` together with the batch creation in the `load_data` function.

```python
# parse all the tiles 
png = np.array(Image.open(full_fn).convert('RGB'));
for x in range(0, png.shape[1], APS):
    for y in range(0, png.shape[0], APS):
       # apply some transformation and add the patch in the batch 
       # until we reach the required BatchSize
       if xind >= BatchSize:
            break;
```

Tiles will not be split across batches. E.g. if the tile size is 10x10 and patch size is 1x1, there are 100 patches in one tile. If the BatchSize is 196, one batch will contain 200 patches (2 tiles).


### Running instructions

In order to use the tensorflow spack package on Summit:
```
module load open-ce
```

Using a custom installation of tensorflow:
```
BUILDS=/gpfs/alpine/world-shared/stf008/bing/stemdl_benchmark/1.14.0
source $BUILDS/env.sh
```

Using Darshan DXT
```
module load darshan-runtime/3.2.1
#export DXT_ENABLE_IO_TRACE=1
export DARSHAN_DISABLE_SHARED_REDUCTION=1
export DXT_ENABLE_IO_TRACE=4
```

For applications needing tensorflow version 1
```
module load ibm-wml-ce/1.6.2-1
```

## Quip Classification

Code can be found in `/gpfs/alpine/csc143/proj-shared/againaru/medical/quip_app` (Also in Dmitry's folder `/gpfs/alpine/world-shared/csc143/ganyushin/quip_app`)

The `data` contains the input and output data stored in 4 folders:
- `Output` contains the logs generated by the run
- `patches` contains short set of png images for debugging runs
- `patches.org` lager set of png images
- `svs` is a symbolic link for raw image data pointing to `/gpfs/alpine/csc303/world-shared/tkurc1/wsi/brca/`

**Modifications to the code**

In the `quip_classification`, all the configuration files from the `u24_lymphocyte` need to point to the current path.
The following files need to be updated to point to the root path of the quip benchmark:
```
u24_lymphocyte/conf/variables.sh
u24_lymphocyte/prediction/NNFramework_TF_models/config_incep-mix_test_ext.ini
u24_lymphocyte/prediction/NNFramework_TF_models/config_incep-mix_test_ext.ini.new
u24_lymphocyte/prediction/NNFramework_TF_models/config_incep-mix_test_ext_binary.ini
u24_lymphocyte/prediction/NNFramework_TF_models/config_incep-mix_test_ext_binary.ini.new
u24_lymphocyte/prediction/NNFramework_TF_models/config_vgg-mix_test_ext.ini
u24_lymphocyte/prediction/NNFramework_TF_models/config_vgg-mix_test_ext.ini.new
u24_lymphocyte/prediction/NNFramework_TF_models/config_vgg-mix_test_ext_binary.ini
u24_lymphocyte/prediction/NNFramework_TF_models/config_vgg-mix_test_ext_binary.ini.new
```

Example line that needs update (in `u24_lymphocyte/conf/variables.sh`):
```
export APP_DIR=/gpfs/alpine/csc143/proj-shared/againaru/medical/quip_app
```

**Running the benchmark on Summit**

Benchmark consist of 3 steps:
- Preprocessing: making png files from raw images in data/patches
- Classification
- Postprocessing

**Classification**

```
cd quip_app/quip_classification/
bsub dl_benchmark.sh
```

Logs will be created in `data/output`. A `patch-level-lym.txt` file will be created in `data/patches/*.svs/` folders.
 
 
## ECP CANDLE 

### Manual installation of TensorFlow

**1. Installing Anaconda**

```
curl -o Anaconda3-2020.02-Linux-x86_32.sh https://repo.anaconda.com/archive/Anaconda3-2020.02-Linux-ppc64le.sh
chmod u+x ./Anaconda3-2020.02-Linux-x86_32.sh
./Anaconda3-2020.02-Linux-x86_32.sh

export PATH=$HOME/anaconda3/bin:$PATH
```

**2. Install TenserFlow**

```
conda install tensorflow
```

